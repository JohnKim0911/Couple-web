<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="planMapper">

	<resultMap id="scheduleResult" type="Schedule">
		<result column="schedule_no" property="scheduleNo"/>
		<result column="calendar_no" property="calendarNo"/>
		<result column="title" property="title"/>
		<result column="content" property="content"/>
		<result column="start_date" property="startDate"/>
		<result column="start_time" property="startTime"/>
		<result column="end_date" property="endDate"/>
		<result column="end_time" property="endTime"/>
		<result column="create_date" property="createDate"/>
		<result column="alert_date" property="alertDate"/>
		<result column="color" property="color"/>
		<result column="writer" property="writer"/>
		<result column="status" property="status"/>
	</resultMap>

	<select id="selectScheduleList" resultMap="scheduleResult">
		select 
		       schedule_no
		     , calendar_no
		     , title
		     , content
		     , to_char(start_date, 'YYYY-MM-DD') as "start_date"
		     , nvl(to_char(start_time, 'HH24:MI:SS'), '') as "start_time"
		     , to_char(end_date, 'YYYY-MM-DD') as "end_date"
		     , nvl(to_char(end_time, 'HH24:MI:SS'), '') as "end_time"
		     , create_date
		     , alert_date
		     , nvl(color, default_color) as "color"
		     , writer
		     , s.status
		  from p_schedule s
          join p_calendar c using(calendar_no)
		 where couple_code = #{coupleCode}
           and start_date between to_date(#{yearMonth}, 'YYYY-MM-DD')-14 and last_day(to_date(#{yearMonth}, 'YYYY-MM-DD'))+14
		   and s.status = 'Y'
	</select>
	
	<insert id="insertSchedule">
		insert
		  into p_schedule
		  (
		      schedule_no
		    , calendar_no
		    , schedule_title
		    , schedule_content
		    , start_date
		    , end_date
		    , create_date
		    , writer_email
		    , color
		    , is_anniversary
		  )
		  values
		  (
		      seq_schedule_no.nextval
		    , #{calendarNo}
		    , #{scheduleTitle}
		    , #{scheduleContent}
		    , CASE
			        WHEN LENGTH(#{startDate}) = 10 THEN TO_DATE(#{startDate}, 'YYYY-MM-DD')
			        WHEN LENGTH(#{startDate}) = 19 THEN TO_DATE(#{startDate}, 'YYYY-MM-DD"T"HH24:MI:SS')
			        ELSE NULL
			  END
			, CASE
			        WHEN LENGTH(#{endDate}) = 10 THEN TO_DATE(#{endDate}, 'YYYY-MM-DD')
			        WHEN LENGTH(#{endDate}) = 19 THEN TO_DATE(#{endDate}, 'YYYY-MM-DD"T"HH24:MI:SS')
			        ELSE NULL
			  END
		    , sysdate
		    , #{writerEmail}
		    , #{color}
		    , #{isAnniversary}
		   )
	</insert>

</mapper>